<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="spring-cloud-health-check"><meta name="keywords" content=""><meta name="author" content="yunnight"><meta name="copyright" content="yunnight"><title>spring-cloud-health-check | yunnight</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#健康检查原理"><span class="toc-number">1.</span> <span class="toc-text">健康检查原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义HealthIndicator"><span class="toc-number">1.1.</span> <span class="toc-text">自定义HealthIndicator</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#客户端自我检查后上报"><span class="toc-number">2.</span> <span class="toc-text">客户端自我检查后上报</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringBoot-Admin主动调用"><span class="toc-number">3.</span> <span class="toc-text">SpringBoot Admin主动调用</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/yunnight/pics/master/blog_avatar.jpg"></div><div class="author-info__name text-center">yunnight</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">18</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">9</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">yunnight</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">spring-cloud-health-check</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-22</time></div><div class="article-container" id="post-content"><p>依赖版本：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="健康检查原理"><a href="#健康检查原理" class="headerlink" title="健康检查原理"></a>健康检查原理</h1><p>得到服务的健康状态的接口是<code>HealthCheckHandler</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HealthCheckHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    InstanceInfo.<span class="function">InstanceStatus <span class="title">getStatus</span><span class="params">(InstanceInfo.InstanceStatus currentStatus)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>InstanceStatus</code>是服务健康状态的枚举：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> InstanceStatus &#123;</span><br><span class="line">    UP, <span class="comment">// Ready to receive traffic</span></span><br><span class="line">    DOWN, <span class="comment">// Do not send traffic- healthcheck callback failed</span></span><br><span class="line">    STARTING, <span class="comment">// Just about starting- initializations to be done - do not</span></span><br><span class="line">    <span class="comment">// send traffic</span></span><br><span class="line">    OUT_OF_SERVICE, <span class="comment">// Intentionally shutdown for traffic</span></span><br><span class="line">    UNKNOWN;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HealthCheckHandler 接口有两个实现类，<code>HealthCheckCallbackToHandlerBridge</code>和<code>EurekaHealthCheckHandler</code>。前者是默认配置，它的 getStatus() 只会返回 UP 状态。<code>EurekaHealthCheckHandler</code>是在配置项<code>eureka.client.healthcheck.enabled = true</code>时自动装配的，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"eureka.client.healthcheck.enabled"</span>, matchIfMissing = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaHealthCheckHandlerConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> HealthAggregator healthAggregator = <span class="keyword">new</span> OrderedHealthAggregator();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(HealthCheckHandler<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">	<span class="title">public</span> <span class="title">EurekaHealthCheckHandler</span> <span class="title">eurekaHealthCheckHandler</span>() </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> EurekaHealthCheckHandler(<span class="keyword">this</span>.healthAggregator);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EurekaHealthCheckHandler 的 getStatus() 是调用其成员<code>CompositeHealthIndicator</code>的<code>getHealth()</code>方法来得到状态的。CompositeHealthIndicator 是<code>HealthIndicator</code>接口的实现类。</p>
<p><code>HealthIndicator</code>接口只有一个方法<code>health()</code>，这个方法负责健康检查，检查完毕返回<code>Health</code>对象。Health 对象只有两个属性：<code>status</code>代表服务状态，<code>details</code>是更细致的说明。</p>
<p>不同的 HealthIndicator 实现类检查内容不同，如<code>DataSourceHealthIndicator</code>是检查数据库连接的，<code>DiskSpaceHealthIndicator</code>是检查内存大小的。<code>CompositeHealthIndicator</code>比较特别，它不是专门检查某个模块的，它的作用是收纳了系统中所有实现了<code>HealthIndicator</code>的Bean，它的<code>health()</code>方法就是遍历调用这些<code>HealthIndicator.health()</code>方法，将每个方法返回的 Health 对象的 status 属性，用<code>HealthAggregator</code>类聚合为一个 status 返回。聚合方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Status <span class="title">aggregateStatus</span><span class="params">(List&lt;Status&gt; candidates)</span> </span>&#123; <span class="comment">// 参数就是所有status</span></span><br><span class="line">	<span class="comment">// 过滤未定义的状态</span></span><br><span class="line">	List&lt;Status&gt; filteredCandidates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	<span class="keyword">for</span> (Status candidate : candidates) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.statusOrder.contains(candidate.getCode())) &#123;</span><br><span class="line">			filteredCandidates.add(candidate);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If no status is given return UNKNOWN</span></span><br><span class="line">	<span class="keyword">if</span> (filteredCandidates.isEmpty()) &#123;</span><br><span class="line">		<span class="keyword">return</span> Status.UNKNOWN;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 把所有Status 按照以下顺序排序，取第一个</span></span><br><span class="line">	<span class="comment">// Status.DOWN, Status.OUT_OF_SERVICE, Status.UP, Status.UNKNOWN</span></span><br><span class="line">	filteredCandidates.sort(<span class="keyword">new</span> StatusComparator(<span class="keyword">this</span>.statusOrder));</span><br><span class="line">	<span class="keyword">return</span> filteredCandidates.get(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>聚合后的Health对象示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>:<span class="string">"UP"</span>,</span><br><span class="line">    <span class="attr">"details"</span>:&#123;</span><br><span class="line">        <span class="attr">"diskSpace"</span>:&#123;</span><br><span class="line">            <span class="attr">"status"</span>:<span class="string">"UP"</span>,</span><br><span class="line">            <span class="attr">"details"</span>:&#123;</span><br><span class="line">                <span class="attr">"total"</span>:<span class="number">297428578304</span>,</span><br><span class="line">                <span class="attr">"free"</span>:<span class="number">243281637376</span>,</span><br><span class="line">                <span class="attr">"threshold"</span>:<span class="number">10485760</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"refreshScope"</span>:&#123;</span><br><span class="line">            <span class="attr">"status"</span>:<span class="string">"UP"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"discoveryComposite"</span>:&#123;</span><br><span class="line">            <span class="attr">"status"</span>:<span class="string">"UP"</span>,</span><br><span class="line">            <span class="attr">"details"</span>:&#123;</span><br><span class="line">                <span class="attr">"discoveryClient"</span>:&#123;</span><br><span class="line">                    <span class="attr">"status"</span>:<span class="string">"UP"</span>,</span><br><span class="line">                    <span class="attr">"details"</span>:&#123;</span><br><span class="line">                        <span class="attr">"services"</span>:[</span><br><span class="line">                            <span class="string">"spring-cloud-register2"</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"eureka"</span>:&#123;</span><br><span class="line">                    <span class="attr">"description"</span>:<span class="string">"Remote status from Eureka server"</span>,</span><br><span class="line">                    <span class="attr">"status"</span>:<span class="string">"UP"</span>,</span><br><span class="line">                    <span class="attr">"details"</span>:&#123;</span><br><span class="line">                        <span class="attr">"applications"</span>:&#123;</span><br><span class="line">                            <span class="attr">"SPRING-CLOUD-REGISTER2"</span>:<span class="number">1</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"hystrix"</span>:&#123;</span><br><span class="line">            <span class="attr">"status"</span>:<span class="string">"UP"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义HealthIndicator"><a href="#自定义HealthIndicator" class="headerlink" title="自定义HealthIndicator"></a>自定义HealthIndicator</h2><p>自定义的 HealthIndicator 可以实现自己的健康检查机制。实现类只需要用<code>@Component</code>注解注入就行。<br>代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHealthIndicator</span> <span class="keyword">implements</span> <span class="title">HealthIndicator</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Health <span class="title">health</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Health.up().build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="客户端自我检查后上报"><a href="#客户端自我检查后上报" class="headerlink" title="客户端自我检查后上报"></a>客户端自我检查后上报</h1><p>Spring Cloud Client 依赖了<code>spring-boot-starter-actuator</code>，并配置<code>eureka.client.healthcheck.enabled = true</code>之后，会自己定时地执行健康检查，若健康状态与上一次检查的不一致，会调用 Server 的<strong>注册</strong>接口，将自己的状态告诉 Server，这样注册中心的页面上可以看到此客户端的健康状态变了。</p>
<blockquote>
<p>注册中心的注册接口：POST /eureka/apps/{appId}。appId就是配置文件中的<code>spring.application.name</code>，请求体是<code>InstanceInfo</code>类，其中属性<code>status</code>就是服务的健康状态。</p>
</blockquote>
<p><code>DiscoveryClient</code>初始化时，调用自己的<code>initScheduledTasks()</code>，这个方法中判断配置项<code>eureka.client.registerWithEureka = true</code>时，初始化<code>InstanceInfoReplicator</code>，并调用其 start() 方法。</p>
<p>InstanceInfoReplicator 继承自 Runnable 接口，它有个成员<code>ScheduledExecutorService scheduler</code>，这是可以设置执行周期性任务或延时任务的线程池类，执行的任务内容基本就是 InstanceInfoReplicator 定义的 run 方法。</p>
<p>InstanceInfoReplicator.run() 方法中调用 DiscoveryClient.refreshInstanceInfo() 方法，DiscoveryClient.refreshInstanceInfo() 方法中调用 EurekaHealthCheckHandler.getStatus() 方法执行健康检查，再调用 ApplicationInfoManager.setInstanceStatus(status) 将检查结果 InstanceStatus 传给<code>ApplicationInfoManager</code>类。</p>
<p>ApplicationInfoManager.setInstanceStatus() 源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setInstanceStatus</span><span class="params">(InstanceStatus status)</span> </span>&#123;</span><br><span class="line">      InstanceStatus next = instanceStatusMapper.map(status);</span><br><span class="line">      <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// 设置新状态，返回旧状态</span></span><br><span class="line">      InstanceStatus prev = instanceInfo.setStatus(next);</span><br><span class="line">      <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">for</span> (StatusChangeListener listener : listeners.values()) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  listener.notify(<span class="keyword">new</span> StatusChangeEvent(prev, next));</span><br><span class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                  logger.warn(<span class="string">"failed to notify listener: &#123;&#125;"</span>, listener.getId(), e);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中，若 InstanceInfo 的前一个状态 prev 不为 null，会将两个状态作为一个<code>StatusChangeEvent</code>事件通知到<code>StatusChangeListener</code>类。而我们从<code>InstanceInfo.setStatus()</code>方法中得知，当前后状态一致，即健康状态不变，返回的 prev 就是 null，ApplicationInfoManager 就不会通知 StatusChangeListener。</p>
<p>StatusChangeListener 的实现类也是在 DiscoveryClient.initScheduledTasks() 中定义好的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		</span><br><span class="line">		statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</span><br><span class="line">						InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</span><br><span class="line">					<span class="comment">// log at warn level if DOWN was involved</span></span><br><span class="line">					logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">				&#125;</span><br><span class="line">				instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，它监听到 StatusChangeEvent 事件后，调用了<code>InstanceInfoReplicator.onDemandUpdate()</code>方法，而这个方法中其实就是调用了 InstanceInfoReplicator.run() 方法。</p>
<p>InstanceInfoReplicator.run() 源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceInfoReplicator</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            discoveryClient.refreshInstanceInfo();</span><br><span class="line"></span><br><span class="line">            Long dirtyTimestamp = instanceInfo.isDirtyWithTime();</span><br><span class="line">            <span class="keyword">if</span> (dirtyTimestamp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                discoveryClient.register();</span><br><span class="line">                instanceInfo.unsetIsDirty(dirtyTimestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            logger.warn(<span class="string">"There was a problem with the instance info replicator"</span>, t);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Future next = scheduler.schedule(<span class="keyword">this</span>, replicationIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">            scheduledPeriodicRef.set(next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法中除了调用 DiscoveryClient.refreshInstanceInfo() 方法触发健康检查以外，还会调用 DiscoveryClient.register() 进行注册，在这之前有个判断，判断当前 InstanceInfo 是否已经“Dirty”了，若是就要重新注册。“Dirty”的设置在上面提到的 InstanceInfo.setStatus() 方法中，简单地说，当新旧健康状态不一致时，当前 InstanceInfo 会被设置为 Dirty，于是会重新注册。 </p>
<p>从上面源码中还可以看出，每次执行 run() 方法，都会在 finally 块中设置下一次执行时间是当前时间延迟<code>replicationIntervalSeconds</code>秒，因此等同于每 replicationIntervalSeconds 秒执行一次 run() 方法，这个时间可配置，默认值30秒。</p>
<p>总结：InstanceInfoReplicator.run() 周期性执行，默认周期30秒，每次执行都会触发 EurekaHealthCheckHandler 进行健康检查（调用链：InstanceInfoReplicator.run() -&gt; DiscoveryClient.refreshInstanceInfo() -&gt; EurekaHealthCheckHandler.getStatus()）。若本次检查结果和上次不一样，就会再次发送注册请求，上报自己的状态信息，注册中心页面上的服务状态就会更新（调用链：ApplicationInfoManager.setInstanceStatus() -&gt; StatusChangeListener.notify() -&gt; InstanceInfoReplicator.onDemandUpdate() -&gt; InstanceInfoReplicator.run() -&gt; DiscoveryClient.register()）。</p>
<h1 id="SpringBoot-Admin主动调用"><a href="#SpringBoot-Admin主动调用" class="headerlink" title="SpringBoot Admin主动调用"></a>SpringBoot Admin主动调用</h1></div></article><div class="post-meta__tag-list"></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/10/25/java-io/"><span>Java BIO NIO</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By yunnight</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>