<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Shiro过滤器基类介绍"><meta name="keywords" content=""><meta name="author" content="yunnight"><meta name="copyright" content="yunnight"><title>Shiro过滤器基类介绍 | yunnight</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AbstractFilter"><span class="toc-number">2.</span> <span class="toc-text">AbstractFilter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NameableFilter"><span class="toc-number">3.</span> <span class="toc-text">NameableFilter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OncePerRequestFilter"><span class="toc-number">4.</span> <span class="toc-text">OncePerRequestFilter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AdviceFilter"><span class="toc-number">5.</span> <span class="toc-text">AdviceFilter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PathMatchingFilter"><span class="toc-number">6.</span> <span class="toc-text">PathMatchingFilter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AccessControlFilter"><span class="toc-number">7.</span> <span class="toc-text">AccessControlFilter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AuthenticationFilter-和-AuthenticatingFilter"><span class="toc-number">8.</span> <span class="toc-text">AuthenticationFilter 和 AuthenticatingFilter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AuthorizationFilter"><span class="toc-number">9.</span> <span class="toc-text">AuthorizationFilter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LogoutFilter"><span class="toc-number">10.</span> <span class="toc-text">LogoutFilter</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/yunnight/pics/master/blog_avatar.jpg"></div><div class="author-info__name text-center">yunnight</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">42</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">10</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">12</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">yunnight</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">Shiro过滤器基类介绍</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-01</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Shiro/"> Shiro</a></div><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Shiro 已经实现的过滤器有以下几种：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> DefaultFilter &#123;</span><br><span class="line">    anon(AnonymousFilter<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line"><span class="class">    <span class="title">authc</span>(<span class="title">FormAuthenticationFilter</span>.<span class="title">class</span>), // 认证</span></span><br><span class="line"><span class="class">    <span class="title">authcBasic</span>(<span class="title">BasicHttpAuthenticationFilter</span>.<span class="title">class</span>), // 认证</span></span><br><span class="line"><span class="class">    <span class="title">logout</span>(<span class="title">LogoutFilter</span>.<span class="title">class</span>),</span></span><br><span class="line"><span class="class">    <span class="title">noSessionCreation</span>(<span class="title">NoSessionCreationFilter</span>.<span class="title">class</span>),</span></span><br><span class="line"><span class="class">    <span class="title">perms</span>(<span class="title">PermissionsAuthorizationFilter</span>.<span class="title">class</span>), // 授权</span></span><br><span class="line"><span class="class">    <span class="title">port</span>(<span class="title">PortFilter</span>.<span class="title">class</span>), // 授权</span></span><br><span class="line"><span class="class">    <span class="title">rest</span>(<span class="title">HttpMethodPermissionFilter</span>.<span class="title">class</span>), // 授权</span></span><br><span class="line"><span class="class">    <span class="title">roles</span>(<span class="title">RolesAuthorizationFilter</span>.<span class="title">class</span>), // 授权</span></span><br><span class="line"><span class="class">    <span class="title">ssl</span>(<span class="title">SslFilter</span>.<span class="title">class</span>), // 授权</span></span><br><span class="line"><span class="class">    <span class="title">user</span>(<span class="title">UserFilter</span>.<span class="title">class</span>)</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的枚举名如”anon”是这个过滤器的名字，配置过滤器链时会用到它。上面标注了“认证”的过滤器继承自<code>AuthenticationFilter</code>，“授权”过滤器继承自<code>AuthorizationFilter</code>。这两个过滤器都继承<code>AccessControlFilter</code>，AccessControlFilter 之上又有一系列继承（从父类到子类）：<br>Filter(javax.servlet接口) -&gt; AbstractFilter -&gt; NameableFilter -&gt; OncePerRequestFilter -&gt; AdviceFilter -&gt; PathMatchingFilter -&gt; AccessControlFilter。</p>
<blockquote>
<p>以下展示源码的版本是 Shiro 1.3.2。</p>
</blockquote>
<h1 id="AbstractFilter"><a href="#AbstractFilter" class="headerlink" title="AbstractFilter"></a>AbstractFilter</h1><p>抽象类，实现了 Filter 接口的 init 方法。扩展点包括添加<code>FilterConfig</code>为成员（这个类里包含 filterName 等属性）。部分源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFilter</span> <span class="keyword">extends</span> <span class="title">ServletContextSupport</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> FilterConfig filterConfig;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterConfig <span class="title">getFilterConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> filterConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFilterConfig</span><span class="params">(FilterConfig filterConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.filterConfig = filterConfig;</span><br><span class="line">        setServletContext(filterConfig.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Filter接口的init方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        setFilterConfig(filterConfig); <span class="comment">// 设置成员</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            onFilterConfigSet(); <span class="comment">// 后续设置方法，钩子，可由子类扩展</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (ServletException) e;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isErrorEnabled()) &#123;</span><br><span class="line">                    log.error(<span class="string">"Unable to start Filter: ["</span> + e.getMessage() + <span class="string">"]."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFilterConfigSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Filter接口的destroy方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="NameableFilter"><a href="#NameableFilter" class="headerlink" title="NameableFilter"></a>NameableFilter</h1><p>抽象类，未实现 Filter 接口的任何方法，扩展了一个属性<code>name</code>，用于表示过滤器的名字，这个名字可以外部调用 set 方法设置，如果没有设置，则来源是<code>FilterConfig</code>。部分源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NameableFilter</span> <span class="keyword">extends</span> <span class="title">AbstractFilter</span> <span class="keyword">implements</span> <span class="title">Nameable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            FilterConfig config = getFilterConfig();</span><br><span class="line">            <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.name = config.getFilterName();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="OncePerRequestFilter"><a href="#OncePerRequestFilter" class="headerlink" title="OncePerRequestFilter"></a>OncePerRequestFilter</h1><p>抽象类，实现了 Filter 接口的 doFilter 方法，方法内有控制同一个过滤器只执行一次，且提供了过滤器的开关（默认开启）。在这个方法内调用<code>doFilterInternal</code>方法（抽象方法，由子类实现）真正执行过滤器的逻辑。</p>
<h1 id="AdviceFilter"><a href="#AdviceFilter" class="headerlink" title="AdviceFilter"></a>AdviceFilter</h1><p>抽象类，实现了<code>doFilterInternal</code>方法。实现方式是，在调用<code>filterChain.doFilter()</code>之前调用<code>preHandle</code>方法，之后调用<code>postHandler</code>，执行完整条过滤器后调用<code>afterComplete</code>方法。preHandle、postHandler、afterComplete 是它提供给子类的钩子，可由子类实现。部分源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AdviceFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"UnusedDeclaration"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"UnusedDeclaration"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(ServletRequest request, ServletResponse response, Exception exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        Exception exception = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> continueChain = preHandle(request, response);</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">"Invoked preHandle method.  Continuing chain?: ["</span> + continueChain + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (continueChain) &#123; <span class="comment">// preHandle返回true才执行后面过滤器, false直接中断</span></span><br><span class="line">                executeChain(request, response, chain); <span class="comment">// 调用chain.doFilter()</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            postHandle(request, response);</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">"Successfully invoked postHandle method"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            exception = e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 执行完所有过滤器（或中断）后调用, 里面有afterComplete方法</span></span><br><span class="line">            cleanup(request, response, exception);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="PathMatchingFilter"><a href="#PathMatchingFilter" class="headerlink" title="PathMatchingFilter"></a>PathMatchingFilter</h1><p>抽象类，实现了直接父类 AdviceFilter 定义的三个钩子方法中的<code>preHandle</code>方法。在这个方法里先匹配 requestURI，匹配方法是把 requestURI 和成员<code>Map&lt;String, Object&gt; appliedPaths</code>中保存的URI进行 match。如果 match 失败，preHandle 就直接返回 true，表示去执行下一个过滤器，当前这个过滤器除了匹配URI之外什么都没做。如果 match 成功，再调用<code>onPreHandle</code>方法，此时 onPreHandle 的返回值就是 preHandle 的返回值，可以决定是继续执行后续的过滤器还是中断。onPreHandle 也是一个钩子方法，默认实现直接返回 true，可由子类重写。</p>
<p>很容易想到，在 onPreHandle 内定义的就是当前过滤器对自己匹配的URI的处理工作，如判断用户是否有权访问匹配的URI，有权访问则返回 true，可继续执行后面的过滤器，无权访问则中断。</p>
<p>下面介绍成员<code>Map&lt;String, Object&gt; appliedPaths</code>的含义。map key 为当前过滤器适用的URI，value 为URI对应的“配置”。比如按下面过滤器链的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/logout"</span>, <span class="string">"logout"</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/login"</span>, <span class="string">"anon"</span>); </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/login/submit"</span>, <span class="string">"anon"</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/*.ico"</span>, <span class="string">"anon"</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/**"</span>, <span class="string">"authc"</span>);</span><br><span class="line">factory.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br></pre></td></tr></table></figure>

<p>这将会创建3个 Filter 对象，分别叫 logout、anon、authc（具体的实现类见前言中的<code>DefaultFilter</code>）。每个过滤器的成员 appliedPaths 中的 map key 就是和它们匹配的URI，value 为 null。如”anon”过滤器的 appliedPaths 含3个元素：&lt;”/login”, null&gt;, &lt;”/login/submit”, null&gt;, &lt;”/*.ico”, null&gt;</p>
<p>如果在过滤器名字之后还加了“配置”，像这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filterChainDefinitionMap.put(<span class="string">"/**"</span>, <span class="string">"roles[admin, user]"</span>);</span><br></pre></td></tr></table></figure>
<p>那么”roles”过滤器的 appliedPaths 包含：&lt;”/**”, [“admin”,”user”]&gt;</p>
<blockquote>
<p>appliedPaths 是如何添加的？见博客《SpringShiroFilter原理》中的“创建原理”一节。</p>
</blockquote>
<h1 id="AccessControlFilter"><a href="#AccessControlFilter" class="headerlink" title="AccessControlFilter"></a>AccessControlFilter</h1><p>抽象类，实现了直接父类 PathMatchingFilter 的<code>onPreHandle</code>方法，实现代码是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreHandle</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> isAccessAllowed(request, response, mappedValue) || onAccessDenied(request, response, mappedValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AccessControlFilter 新定义了两个方法：<code>isAccessAllowed</code>和<code>onAccessDenied</code>，但未实现。</p>
<p>onPreHandle 方法的含义是，先执行<code>isAccessAllowed</code>方法判断是否可继续（可访问），若可继续（isAccessAllowed=true），则 onPreHandle=true。若不可继续，则调用<code>onAccessDenied</code>处理不可访问的情况，处理完可返回 true or false。onAccessDenied=true 说明可执行后面的过滤器，onAccessDenied=false 则中断过滤器的执行直接返回响应（如 AdviceFilter 中所述）。</p>
<p>除此以外，AccessControlFilter 还增加了对 loginUrl 的识别和处理，以及获取<code>Subject</code>对象的方法，定义它的子类时可使用这些方法，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前请求线程中的 subject</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Subject <span class="title">getSubject</span><span class="params">(ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> SecurityUtils.getSubject();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否是登录请求</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isLoginRequest</span><span class="params">(ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> pathsMatch(getLoginUrl(), request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="AuthenticationFilter-和-AuthenticatingFilter"><a href="#AuthenticationFilter-和-AuthenticatingFilter" class="headerlink" title="AuthenticationFilter 和 AuthenticatingFilter"></a>AuthenticationFilter 和 AuthenticatingFilter</h1><p>2个都属于认证过滤器，都是抽象类。继承链（从子类到父类）是：AuthenticatingFilter -&gt; AuthenticationFilter -&gt; AccessControlFilter。这两个类都只实现了 isAccessAllowed 方法（如下源码），未实现 onAccessDenied 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthenticationFilter</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> </span>&#123;</span><br><span class="line">	Subject subject = getSubject(request, response);</span><br><span class="line">	<span class="keyword">return</span> subject.isAuthenticated();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AuthenticatingFilter</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.isAccessAllowed(request, response, mappedValue) ||</span><br><span class="line">			(!isLoginRequest(request, response) &amp;&amp; isPermissive(mappedValue));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>考虑到这是一个用于认证的过滤器，就很好理解上面 AuthenticatingFilter.isAccessAllowed() 方法的含义：若用户已登录，或 requestURI 不是 loginUrl 且 requestURI 带有”permissive”配置，则当前过滤器结束，继续执行后续过滤器。否则进入 onAccessDenied 方法内执行认证。</p>
<p>AuthenticatingFilter 与父类相比，扩展了更多和登录有关的方法。</p>
<p>自定义的认证过滤器一般继承于它们，需要实现 onAccessDenied 方法，方法内实现用户登录校验等逻辑。</p>
<h1 id="AuthorizationFilter"><a href="#AuthorizationFilter" class="headerlink" title="AuthorizationFilter"></a>AuthorizationFilter</h1><p>授权过滤器，抽象类，继承自 AccessControlFilter，实现了 onAccessDenied 方法（如下源码），代表不可访问后的处理，未实现 isAccessAllowed 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">     Subject subject = getSubject(request, response);</span><br><span class="line">     <span class="comment">// 若用户未登录，重定向到loginUrl</span></span><br><span class="line">     <span class="keyword">if</span> (subject.getPrincipal() == <span class="keyword">null</span>) &#123;</span><br><span class="line">         saveRequestAndRedirectToLogin(request, response);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 401页面URL</span></span><br><span class="line">         String unauthorizedUrl = getUnauthorizedUrl();</span><br><span class="line"><span class="comment">// 若有401页面就重定向到此页，若无则只返回HTTP状态码401</span></span><br><span class="line">         <span class="keyword">if</span> (StringUtils.hasText(unauthorizedUrl)) &#123;</span><br><span class="line">             WebUtils.issueRedirect(request, response, unauthorizedUrl);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             WebUtils.toHttp(response).sendError(HttpServletResponse.SC_UNAUTHORIZED);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>自定义的授权过滤器一般继承于它，需要实现 isAccessAllowed 方法，方法内判断 requestURI 是否可访问。</p>
<h1 id="LogoutFilter"><a href="#LogoutFilter" class="headerlink" title="LogoutFilter"></a>LogoutFilter</h1><p>继承自 AdviceFilter，只实现了 preHandle 方法。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Subject subject = getSubject(request, response);</span><br><span class="line">    String redirectUrl = getRedirectUrl(request, response, subject); <span class="comment">// 退出登录后跳转的页面</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        subject.logout(); <span class="comment">// 执行用户退出登录的操作</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SessionException ise) &#123;</span><br><span class="line">        log.debug(<span class="string">"Encountered session exception during logout.  This can generally safely be ignored."</span>, ise);</span><br><span class="line">    &#125;</span><br><span class="line">    issueRedirect(request, response, redirectUrl); <span class="comment">// 跳转页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// 返回false说明中断Shiro过滤器链</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给 URL=”/logout” 配置这个 Filter，就能在用户点击“退出登录”时进入这个 Filter，完成退出以及退出后跳转页面的操作，不需要自己写用户退出时的代码。</p>
<p>另外，退出后跳转页面默认URL=”/“，如果要自定义，则需要这样配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LogoutFilter logoutFilter = <span class="keyword">new</span> LogoutFilter();</span><br><span class="line">logoutFilter.setRedirectUrl(<span class="string">"/login"</span>); <span class="comment">// 自定义跳转页面</span></span><br><span class="line"></span><br><span class="line">Map&lt;String, Filter&gt; filtersMap = <span class="keyword">new</span> LinkedHashMap&lt;String, Filter&gt;();</span><br><span class="line">filtersMap.put(<span class="string">"logout"</span>, logoutFilter); <span class="comment">// 用自己的实例替换默认的LogoutFilter实例</span></span><br><span class="line">factory.setFilters(filtersMap); <span class="comment">// 设置到 ShiroFilterFactoryBean</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置过滤器链</span></span><br><span class="line">Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/logout"</span>, <span class="string">"logout"</span>);</span><br><span class="line"><span class="comment">// 以下略...</span></span><br></pre></td></tr></table></figure>










</div></article><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/10/05/tomcat-filter-chain/"><i class="fa fa-chevron-left">  </i><span>Tomcat过滤器链原理</span></a></div><div class="next-post pull-right"><a href="/2021/08/18/java8-stream-api-note/"><span>Java8 Stream API 常用方法</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By yunnight</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>